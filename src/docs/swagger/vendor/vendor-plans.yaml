paths:
  /vendor/plans/initiate-payment:
    post:
      summary: Initiate vendor plan payment via virtual account
      description: Create a transaction and generate a virtual account for a vendor to subscribe to a plan via bank transfer.
      tags: [Vendor Plans]
      operationId: vendorInitiatePlanPayment
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitiatePlanPaymentRequest'
            example:
              planId: "60d0fe4f5311236168a109ca"
      responses:
        200:
          description: Virtual account generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitiatePlanPaymentSuccessResponse'
              examples:
                success:
                  value:
                    success: true
                    message: Virtual account generated successfully
                    data:
                      id: "va_01HZ3KJ9KJ8QW"
                      merchantId: "m_123"
                      virtualBankCode: "035"
                      virtualBankAccountNumber: "1234567890"
                      businessBankAccountNumber: null
                      businessBankCode: "035"
                      transactionId: "txn_01HZ3KJ9KJ8QW"
                      status: "PENDING"
                      expiredAt: "2026-02-10T12:00:00Z"
                      settlementType: null
                      createdAt: "2026-02-08T11:00:00Z"
                      businessId: "biz_001"
                      amount: 5000
                      currency: "NGN"
                      orderId: "plan-basic-ven_001-1739010000000"
                      description: "Subscription to Basic Plan"
                      subBusinessCode: null
                      customer:
                        email: "vendor@example.com"
                        phone: "08012345678"
                        firstName: "Ada"
                        lastName: "Okafor"
                        metadata: "{\"vendorId\":\"ven_001\",\"planId\":\"plan_basic\"}"
                      callbackEndpoint: "/v1/api/vendor/plans/payment-callback"
                      reference: "plan-plan_basic-ven_001-1739010000000"
        400:
          description: Failed to initiate payment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Failed to initiate payment"
        404:
          description: Vendor or plan not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Vendor not found"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Internal server error"
      x-codeSamples:
        - lang: curl
          label: Shell
          source: |
            curl -X POST \
              "${BASE_URL}/v1/api/vendor/plans/initiate-payment" \
              -H "Authorization: Bearer ${JWT}" \
              -H "Content-Type: application/json" \
              -d '{"planId":"60d0fe4f5311236168a109ca"}'
        - lang: JavaScript
          label: fetch
          source: |
            await fetch(`${BASE_URL}/v1/api/vendor/plans/initiate-payment`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${JWT}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ planId: '60d0fe4f5311236168a109ca' })
            })

  /vendor/plans/payment-callback:
    post:
      summary: Confirm plan payment status via callback
      description: Verify transaction status from AlatPay and return validation details.
      tags: [Vendor Plans]
      operationId: vendorPlanPaymentCallback
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentCallbackRequest'
            example:
              transactionId: "txn_01HZ3KJ9KJ8QW"
      responses:
        200:
          description: Callback received
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentCallbackSuccessResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Callback received"
                    data:
                      status: "SUCCESSFUL"
                      isValidated: true
                      transaction:
                        id: "txn_01HZ3KJ9KJ8QW"
                        merchantId: "m_123"
                        businessId: "biz_001"
                        status: "SUCCESSFUL"
                        currency: "NGN"
                        amount: 5000
                        orderId: "plan-plan_basic-ven_001-1739010000000"
                        isCallbackValidated: true
                        ngnVirtualBankAccountNumber: "1234567890"
                        ngnVirtualBankCode: "035"
                        nipTransaction:
                          id: "nip_01HZ3..."
                          transactionId: "txn_01HZ3KJ9KJ8QW"
                          transactionStatus: "SUCCESSFUL"
                          bankcode: "035"
                          craccount: "1234567890"
                        virtualAccount:
                          id: "va_01HZ3KJ9KJ8QW"
                          transactionId: "txn_01HZ3KJ9KJ8QW"
                          status: "SUCCESSFUL"
        400:
          description: Callback verification failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Callback verification failed"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Internal server error"
      x-codeSamples:
        - lang: curl
          label: Shell
          source: |
            curl -X POST \
              "${BASE_URL}/v1/api/vendor/plans/payment-callback" \
              -H "Content-Type: application/json" \
              -d '{"transactionId":"txn_01HZ3KJ9KJ8QW"}'

components:
  schemas:
    InitiatePlanPaymentRequest:
      type: object
      properties:
        planId:
          type: string
          description: Unique identifier of the plan to subscribe to.
      required: [planId]

    VirtualAccount:
      type: object
      properties:
        id:
          type: string
        merchantId:
          type: string
        virtualBankCode:
          type: string
        virtualBankAccountNumber:
          type: string
        businessBankAccountNumber:
          type: string
          nullable: true
        businessBankCode:
          type: string
        transactionId:
          type: string
        status:
          type: string
          description: Current status of the virtual account transaction.
          enum: [PENDING, SUCCESSFUL, FAILED, EXPIRED]
        expiredAt:
          type: string
          format: date-time
        settlementType:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        businessId:
          type: string
        amount:
          type: number
        currency:
          type: string
          description: 3-letter currency code
          example: NGN
        orderId:
          type: string
        description:
          type: string
        subBusinessCode:
          type: string
          nullable: true
        customer:
          type: object
          properties:
            email:
              type: string
              format: email
            phone:
              type: string
            firstName:
              type: string
            lastName:
              type: string
            metadata:
              type: string
        virtualAccountNumber:
          type: string
          nullable: true
        bankName:
          type: string
          nullable: true
        accountName:
          type: string
          nullable: true
        expiryTime:
          type: string
          nullable: true
        reference:
          type: string
          nullable: true
        callbackEndpoint:
          type: string
        transactionIdInternal:
          type: string
        referenceInternal:
          type: string

    InitiatePlanPaymentSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          allOf:
            - $ref: '#/components/schemas/VirtualAccount'
            - type: object
              properties:
                callbackEndpoint:
                  type: string
                transactionId:
                  type: string
                reference:
                  type: string

    PaymentCallbackRequest:
      type: object
      properties:
        transactionId:
          type: string
      required: [transactionId]

    TransactionStatus:
      type: object
      properties:
        amount:
          type: number
        orderId:
          type: string
        description:
          type: string
        isAmountDiscrepant:
          type: boolean
        amountSent:
          type: number
        nipTransaction:
          type: object
          properties:
            id:
              type: string
            transactionId:
              type: string
            transactionStatus:
              type: string
            bankcode:
              type: string
            craccount:
              type: string
        virtualAccount:
          type: object
          properties:
            id:
              type: string
            transactionId:
              type: string
            status:
              type: string
            expiredAt:
              type: string
              format: date-time
            amount:
              type: number
            currency:
              type: string
            orderId:
              type: string
        customer:
          type: object
          properties:
            id:
              type: string
            email:
              type: string
              format: email
            phone:
              type: string
            firstName:
              type: string
            lastName:
              type: string
        isCallbackValidated:
          type: boolean
        id:
          type: string
        merchantId:
          type: string
        businessId:
          type: string
        currency:
          type: string
        status:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        ngnVirtualBankAccountNumber:
          type: string
          nullable: true
        ngnVirtualBankCode:
          type: string
          nullable: true
        usdVirtualAccountNumber:
          type: string
          nullable: true
        usdVirtualBankCode:
          type: string
          nullable: true

    PaymentCallbackSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          properties:
            status:
              type: string
            isValidated:
              type: boolean
            transaction:
              $ref: '#/components/schemas/TransactionStatus'

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
