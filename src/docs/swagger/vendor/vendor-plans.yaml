paths:
  /vendor/plans/initiate-payment:
    post:
      summary: Initiate vendor plan payment
      description: Create a transaction and generate a payment link (Flutterwave) for a vendor to subscribe to a plan.
      tags: [Vendor Plans]
      operationId: vendorInitiatePlanPayment
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitiatePlanPaymentRequest'
            example:
              planId: "60d0fe4f5311236168a109ca"
      responses:
        200:
          description: Payment link generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitiatePlanPaymentSuccessResponse'
              examples:
                success:
                  value:
                    success: true
                    message: Payment link generated successfully
                    data:
                      link: "https://checkout.flutterwave.com/pay/abc123"
                      callbackEndpoint: "/v1/api/vendor/plans/payment-callback"
                      transactionId: "txn_01HZ3KJ9KJ8QW"
                      reference: "plan-plan_basic-ven_001-1739010000000"
        400:
          description: Failed to initiate payment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Failed to initiate payment"
        404:
          description: Vendor or plan not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Vendor not found"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Internal server error"
      x-codeSamples:
        - lang: curl
          label: Shell
          source: |
            curl -X POST \
              "${BASE_URL}/v1/api/vendor/plans/initiate-payment" \
              -H "Authorization: Bearer ${JWT}" \
              -H "Content-Type: application/json" \
              -d '{"planId":"60d0fe4f5311236168a109ca"}'
        - lang: JavaScript
          label: fetch
          source: |
            await fetch(`${BASE_URL}/v1/api/vendor/plans/initiate-payment`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${JWT}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ planId: '60d0fe4f5311236168a109ca' })
            })

  /vendor/plans/payment-callback:
    post:
      summary: Confirm plan payment status via callback
      description: Verify transaction status from Flutterwave and return validation details.
      tags: [Vendor Plans]
      operationId: vendorPlanPaymentCallback
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/PaymentCallbackRequestWithTxRef'
                - $ref: '#/components/schemas/PaymentCallbackRequestWithTransactionId'
            example:
              transactionId: "txn_01HZ3KJ9KJ8QW"
      responses:
        200:
          description: Callback received
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentCallbackSuccessResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Callback received"
                    data:
                      status: "successful"
                      isValidated: true
                      transaction:
                        status: "successful"
                        message: "Transaction fetched successfully"
                        data:
                          tx_ref: "plan-plan_basic-ven_001-1739010000000"
                          amount: 5000
                          currency: "NGN"
                          status: "successful"
                          customer:
                            email: "vendor@example.com"
                            name: "Ada Okafor"
                            phone_number: "08012345678"
                          created_at: "2026-02-08T12:34:56Z"
        400:
          description: Callback verification failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Callback verification failed"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Internal server error"
      x-codeSamples:
        - lang: curl
          label: Shell
          source: |
            curl -X POST \
              "${BASE_URL}/v1/api/vendor/plans/payment-callback" \
              -H "Content-Type: application/json" \
              -d '{"transactionId":"txn_01HZ3KJ9KJ8QW"}'

components:
  schemas:
    InitiatePlanPaymentRequest:
      type: object
      properties:
        planId:
          type: string
          description: Unique identifier of the plan to subscribe to.
      required: [planId]
    InitiatePlanPaymentSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          properties:
            link:
              type: string
              description: Flutterwave payment link for checkout
            callbackEndpoint:
              type: string
            transactionId:
              type: string
            reference:
              type: string

    PaymentCallbackRequestWithTxRef:
      type: object
      properties:
        tx_ref:
          type: string
      required: [tx_ref]

    PaymentCallbackRequestWithTransactionId:
      type: object
      properties:
        transactionId:
          type: string
      required: [transactionId]

    FlutterwaveVerificationWithReferenceResponse:
      type: object
      properties:
        status:
          type: string
          example: successful
        message:
          type: string
          example: Transaction fetched successfully
        data:
          type: object
          properties:
            id:
              type: number
            tx_ref:
              type: string
            amount:
              type: number
            currency:
              type: string
            status:
              type: string
            customer:
              type: object
              properties:
                email:
                  type: string
                name:
                  type: string
                phone_number:
                  type: string
            created_at:
              type: string
              format: date-time

    PaymentCallbackSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          properties:
            status:
              type: string
            isValidated:
              type: boolean
            transaction:
              $ref: '#/components/schemas/FlutterwaveVerificationWithReferenceResponse'

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
